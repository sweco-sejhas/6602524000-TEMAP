// Generated by CoffeeScript 1.6.1
(function() {
  'use strict';
  angular.module('TEMAPApp').factory('db', function() {
    var idb, req, timeoutId, updateVersion;
    timeoutId = null;
    idb = null;
    req = indexedDB.open('TEMAP_DB');
    req.onsuccess = function(evt) {
      return idb = req.result;
    };
    req.onupgradeneeded = function(evt) {
      var osData, osVersion;
      idb = evt.target.result;
      osVersion = idb.createObjectStore('version', {
        keyPath: 'n'
      });
      return osData = idb.createObjectStore('data', {
        keyPath: 'n'
      });
    };
    req.onerror = function(evt) {
      return console.log('IndexedDB error: ' + evt.target.errorCode);
    };
    updateVersion = function(name, version, cb) {
      var store, transaction;
      transaction = idb.transaction(['version'], 'readwrite');
      store = transaction.objectStore('version');
      req = store.put({
        n: name,
        version: version
      });
      req.onerror = function(evt) {};
      return req.onsuccess = function(evt) {
        return cb();
      };
    };
    return {
      initDb: function(cb) {
        var scope;
        scope = this;
        if (idb === null) {
          return timeoutId = setTimeout(function() {
            return scope.initDb(cb);
          }, 10);
        } else {
          return cb();
        }
      },
      needsUpdate: function(name, version, update, noUpdate) {
        var store, transaction;
        transaction = idb.transaction(['version'], 'readwrite');
        store = transaction.objectStore('version');
        req = store.get(name);
        req.onerror = function(evt) {};
        return req.onsuccess = function(evt) {
          if ((evt.target.result == null) || evt.target.result.version !== version) {
            return update(name, version);
          } else {
            return noUpdate(name);
          }
        };
      },
      persist: function(name, version, data, cb) {
        var store, transaction;
        transaction = idb.transaction(['data'], 'readwrite');
        transaction.oncomplete = function() {};
        transaction.onerror = function(ev) {};
        store = transaction.objectStore('data');
        req = store.put({
          n: name,
          data: data
        });
        req.onerror = function(evt) {};
        return req.onsuccess = function(evt) {
          return updateVersion(name, version, cb);
        };
      },
      getAsArray: function(name, cb) {
        var store, transaction;
        transaction = idb.transaction(['data'], 'readwrite');
        transaction.oncomplete = function() {};
        store = transaction.objectStore('data');
        req = store.get(name);
        req.onerror = function(evt) {};
        return req.onsuccess = function(evt) {
          return cb(evt.target.result.data);
        };
      }
    };
  });

}).call(this);
