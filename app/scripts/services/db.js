// Generated by CoffeeScript 1.6.1
(function() {
  'use strict';
  angular.module('TEMAPApp').factory('db', function() {
    var idb, req, timeoutId, updateVersion;
    timeoutId = null;
    idb = null;
    req = indexedDB.open('TEMAP_DB');
    req.onsuccess = function(evt) {
      return idb = req.result;
    };
    req.onupgradeneeded = function(evt) {
      var osBelysning, osKabelskap, osNatstationer, osVersion;
      idb = evt.target.result;
      osVersion = idb.createObjectStore('version', {
        keyPath: 'n'
      });
      osBelysning = idb.createObjectStore('belysning', {
        keyPath: 'n'
      });
      osKabelskap = idb.createObjectStore('kabelskap', {
        keyPath: 'n'
      });
      return osNatstationer = idb.createObjectStore('natstationer', {
        keyPath: 'n'
      });
    };
    req.onerror = function(evt) {
      return console.log('IndexedDB error: ' + evt.target.errorCode);
    };
    updateVersion = function(name, version, cb) {
      var store, transaction;
      transaction = idb.transaction(['version'], 'readwrite');
      store = transaction.objectStore('version');
      req = store.put({
        n: name,
        version: version
      });
      req.onerror = function(evt) {};
      return req.onsuccess = function(evt) {
        return cb();
      };
    };
    return {
      initDb: function(cb) {
        var scope;
        scope = this;
        if (idb === null) {
          return timeoutId = setTimeout(function() {
            return scope.initDb(cb);
          }, 10);
        } else {
          return cb();
        }
      },
      clear: function(name, cb) {
        var store, transaction;
        transaction = idb.transaction([name], 'readwrite');
        transaction.oncomplete = cb;
        transaction.onerror = function(ev) {
          return console.log('transaction-error');
        };
        store = transaction.objectStore(name);
        req = store.clear();
        req.onsuccess = function(evt) {};
        return req.onerror = function(evt) {};
      },
      needsUpdate: function(name, version, update, noUpdate) {
        var store, transaction;
        transaction = idb.transaction(['version'], 'readwrite');
        store = transaction.objectStore('version');
        req = store.get(name);
        req.onerror = function(evt) {};
        return req.onsuccess = function(evt) {
          if ((evt.target.result == null) || evt.target.result.version !== version) {
            return update(name, version);
          } else {
            return noUpdate(name);
          }
        };
      },
      persist: function(name, version, data, cb) {
        return this.clear(name, function() {
          var item, store, transaction, _i, _len;
          transaction = idb.transaction([name], 'readwrite');
          transaction.oncomplete = function() {
            return updateVersion(name, version, cb);
          };
          transaction.onerror = function(ev) {};
          store = transaction.objectStore(name);
          for (_i = 0, _len = data.length; _i < _len; _i++) {
            item = data[_i];
            req = store.add(item);
            req.onsuccess = function(evt) {};
            req.onerror = function(ev) {};
          }
        });
      },
      getAsArray: function(name, cb) {
        var all, store, transaction;
        all = [];
        transaction = idb.transaction([name], 'readwrite');
        transaction.oncomplete = function() {
          return cb(all);
        };
        store = transaction.objectStore(name);
        return store.openCursor().onsuccess = function(evt) {
          var cursor;
          cursor = evt.target.result;
          if (cursor != null) {
            all.push(cursor.value);
            return cursor["continue"]();
          }
        };
      }
    };
  });

}).call(this);
